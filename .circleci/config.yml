# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
    build:
        parallelism: 4
        working_directory: ~/repo
        # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
        # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
        docker:
            - image: cimg/go:1.19
            - image: cimg/redis:7.0
            - image: cimg/mysql:8.0
              environment:
                  MYSQL_DATABASE: go-hexagonal
                  MYSQL_USER: user
                  MYSQL_PASSWORD: root
                  MYSQL_ROOT_PASSWORD: root
#              auth:
#                  username: mydockerhub-user
#                  password: $DOCKERHUB_PASSWORD
        # Add steps to the job
        # See: https://circleci.com/docs/2.0/configuration-reference/#steps
        steps:
            - checkout
            - run:
                name: Wait MySQL Start
                command: dockerize -wait tcp://localhost:3306 -timeout 1m
#                command: |
#                    for i in `seq 1 10`;
#                    do
#                      nc -z 127.0.0.1 3306 && echo Success && exit 0
#                      echo -n .
#                      sleep 1
#                    done
#                    echo Failed waiting for MySQL && exit 1
#            - run:
#               name: Init MySQL
#               command: |
#                 sudo apt-get install default-mysql-client --fix-missing
#                 mysql -h 127.0.0.1 -u user -ppassw0rd test_db < sql-data/dummy.sql
#                 mysql -h 127.0.0.1 -u user -ppassw0rd --execute="SELECT * FROM test_db.Persons"
            - restore_cache:
                  keys:
                      - go-mod-v4-{{ checksum "go.sum" }}
            - run:
                  name: Install Dependencies
                  command: go get ./...
            - save_cache:
                  key: go-mod-v4-{{ checksum "go.sum" }}
                  paths:
                      - "/go/pkg/mod"
            - run:
                  name: Run UnitTest
                  command: go test -v $(go list ./... | circleci tests split --split-by=timings)

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
    version: 2
    Build: # This is the name of the workflow, feel free to change it to better match your workflow.
        # Inside the workflow, you define the jobs you want to run.
        jobs:
            - build
